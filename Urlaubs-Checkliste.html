<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Urlaubs-Checkliste</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Modernes Farbschema */
        :root {
            --primary-bg-color: #f7f9fc;
            --secondary-bg-color: #ffffff;
            --border-color: #e2e8f0;
            --text-color: #334e68;
            --heading-color: #2a4158;
            --button-primary: #4a90e2;
            --button-danger: #d9534f;
            --button-success: #28a745;
            --button-dark: #6c757d;
        }

        /* Allgemeine Stile */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: var(--primary-bg-color);
            color: var(--text-color);
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--heading-color);
            font-weight: 600;
        }
        
        h2 {
            margin-top: 0;
            color: var(--heading-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #date {
            text-align: right;
            font-size: 14px;
            color: #6e84a3;
            margin-bottom: 20px;
        }

        #container {
            max-width: 800px;
            margin: auto;
        }

        .category, .special-tasks, .trip-details {
            background: var(--secondary-bg-color);
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }
        .category:hover, .special-tasks:hover, .trip-details:hover {
            transform: translateY(-5px);
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        li {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            cursor: grab;
        }

        li.dragging {
            opacity: 0.5;
        }

        input[type="checkbox"] {
            transform: scale(1.3);
            flex-shrink: 0;
            accent-color: var(--button-primary);
        }
        
        .task-text {
            flex-grow: 1;
            font-size: 1.1em;
        }

        .task-buttons {
            margin-left: auto;
            flex-shrink: 0;
            display: none;
            gap: 8px;
        }

        li:hover .task-buttons {
            display: flex;
        }
        
        .edit-btn, .delete-btn {
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.2em;
            padding: 8px;
            color: #829ab1;
            transition: color 0.2s;
        }

        .edit-btn:hover {
            color: var(--button-primary);
        }
        .delete-btn:hover {
            color: var(--button-danger);
        }

        .abfuhr {
            font-weight: 600;
            color: var(--heading-color);
        }
        
        .add-task-container {
            display: flex;
            margin-top: 20px;
            gap: 10px;
        }

        .add-task-container input {
            flex-grow: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .add-task-container input:focus {
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        .add-task-container button, #resetBtn, #updateBtn, #printBtn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s;
        }
        .add-task-btn, #add-special-task-btn {
            background-color: var(--button-primary);
            color: white;
        }
        .add-task-btn:hover, #add-special-task-btn:hover {
            background-color: #3b76c0;
            transform: translateY(-2px);
        }

        #resetBtn {
            margin: 30px auto;
            display: block;
            background-color: var(--button-danger);
            color: white;
        }
        #resetBtn:hover {
            background-color: #c9302c;
            transform: translateY(-2px);
        }

        #printBtn {
            background-color: var(--button-dark);
            color: white;
        }
        #printBtn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        .trip-details {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .trip-details div {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .trip-details label {
            flex-shrink: 0;
            font-weight: 600;
        }

        .trip-details input[type="number"], .trip-details input[type="date"], .trip-details select {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1em;
        }

        #updateBtn {
            background-color: var(--button-success);
            color: white;
            width: 100%;
        }

        #updateBtn:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        /* Suche */
        #search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        #search-input {
            flex-grow: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            font-size: 1em;
            outline: none;
        }
        #search-input:focus {
            border-color: var(--button-primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        /* Urlaubs-Warnung */
        #vacation-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            display: none; /* Standardm√§√üig versteckt */
        }
        #vacation-warning.visible {
            display: block;
        }

        /* Print-Stile */
        @media print {
            body {
                background: #fff;
                color: #000;
                padding: 0;
            }
            #container {
                box-shadow: none;
            }
            .trip-details, .add-task-container, #resetBtn, #printBtn, #updateBtn, #search-container, #vacation-warning {
                display: none;
            }
            .category, .special-tasks {
                box-shadow: none;
                border: 1px solid #ccc;
                margin-bottom: 15px;
                padding: 15px;
            }
            ul {
                margin: 0;
            }
            li {
                margin-bottom: 5px;
                cursor: default;
                display: block;
            }
            li .task-buttons {
                display: none;
            }
            input[type="checkbox"] {
                margin-right: 10px;
            }
        }
    </style>
</head>
<body>

    <h1>üìã Urlaubs-Checkliste</h1>
    <div id="date"></div>

    <div id="container">
        <div class="trip-details">
            <h2>Details zur Reise</h2>
            <div>
                <label for="trip-duration">Aufenthaltsdauer (Tage):</label>
                <input type="number" id="trip-duration" value="7" min="1">
            </div>
            <div>
                <label for="weather-select">Erwartetes Wetter:</label>
                <select id="weather-select">
                    <option value="sonne">Sonne</option>
                    <option value="regen">Regen/Durchschnittliche Temp.</option>
                    <option value="schnee">Schnee/Kalt</option>
                </select>
            </div>
            <div>
                <label for="washing-machine">Waschmaschine vor Ort:</label>
                <input type="checkbox" id="washing-machine">
            </div>
            <div>
                <label for="trip-start-date">Urlaubsbeginn:</label>
                <input type="date" id="trip-start-date">
            </div>
            <div>
                <label for="trip-end-date">Urlaubsende:</label>
                <input type="date" id="trip-end-date">
            </div>
            <button id="updateBtn">Checkliste aktualisieren</button>
        </div>

        <div id="vacation-warning"></div>

        <div id="search-container">
            <input type="text" id="search-input" placeholder="Checkliste durchsuchen...">
        </div>

        <div class="category" id="general-essentials">
            <h2>üéí Allgemeine Essentials</h2>
            <ul class="task-list"></ul>
            <div class="add-task-container">
                <input type="text" placeholder="Neue Aufgabe hinzuf√ºgen...">
                <button class="add-task-btn">Hinzuf√ºgen</button>
            </div>
        </div>
        <div class="category" id="kleidung-tim">
            <h2>üëï Kleidung TME</h2>
            <ul class="task-list"></ul>
            <div class="add-task-container">
                <input type="text" placeholder="Neue Aufgabe hinzuf√ºgen...">
                <button class="add-task-btn">Hinzuf√ºgen</button>
            </div>
        </div>
        <div class="category" id="kleidung-sina">
            <h2>üëó Kleidung SINA</h2>
            <ul class="task-list"></ul>
            <div class="add-task-container">
                <input type="text" placeholder="Neue Aufgabe hinzuf√ºgen...">
                <button class="add-task-btn">Hinzuf√ºgen</button>
            </div>
        </div>
        <div class="category" id="fuer-das-baby">
            <h2>üë∂ F√ºr das Baby</h2>
            <ul class="task-list"></ul>
            <div class="add-task-container">
                <input type="text" placeholder="Neue Aufgabe hinzuf√ºgen...">
                <button class="add-task-btn">Hinzuf√ºgen</button>
            </div>
        </div>
        <div class="category" id="fuer-den-hund">
            <h2>üêæ F√ºr den Hund</h2>
            <ul class="task-list"></ul>
            <div class="add-task-container">
                <input type="text" placeholder="Neue Aufgabe hinzuf√ºgen...">
                <button class="add-task-btn">Hinzuf√ºgen</button>
            </div>
        </div>
        <div class="category" id="fuer-die-ferienwohnung">
            <h2>üè† F√ºr die Ferienwohnung</h2>
            <ul class="task-list"></ul>
            <div class="add-task-container">
                <input type="text" placeholder="Neue Aufgabe hinzuf√ºgen...">
                <button class="add-task-btn">Hinzuf√ºgen</button>
            </div>
        </div>
        <div class="category" id="fuer-aktivitaeten-und-unterhaltung">
            <h2>üé≤ F√ºr Aktivit√§ten & Unterhaltung</h2>
            <ul class="task-list"></ul>
            <div class="add-task-container">
                <input type="text" placeholder="Neue Aufgabe hinzuf√ºgen...">
                <button class="add-task-btn">Hinzuf√ºgen</button>
            </div>
        </div>
        <div class="category" id="ggf-fuer-camping">
            <h2>üèïÔ∏è Ggf. f√ºr Camping</h2>
            <ul class="task-list"></ul>
            <div class="add-task-container">
                <input type="text" placeholder="Neue Aufgabe hinzuf√ºgen...">
                <button class="add-task-btn">Hinzuf√ºgen</button>
            </div>
        </div>
        <div class="special-tasks" id="sonderaufgaben-div">
            <h2>üöÄ Sonderaufgaben (vorher erledigen)</h2>
            <ul class="special-tasks-list"></ul>
            <div class="add-task-container">
                <input type="text" placeholder="Neue Sonderaufgabe hinzuf√ºgen..." id="new-special-task-input">
                <button id="add-special-task-btn">Hinzuf√ºgen</button>
            </div>
        </div>
    </div>

    <button id="printBtn">üñ®Ô∏è Drucken</button>
    <button id="resetBtn">üîÅ Neu starten</button>
    
    <!-- Firebase SDK Scripts -->
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Your web app's Firebase configuration from the user
        const firebaseConfig = {
            apiKey: "AIzaSyB_ibvOzRdzgvZEOMOeJoPT4FZnin6ueds",
            authDomain: "urlaubs-to-do.firebaseapp.com",
            projectId: "urlaubs-to-do",
            storageBucket: "urlaubs-to-do.appspot.com",
            messagingSenderId: "330245236007",
            appId: "1:330245236007:web:96ba5c6694a9289bb07502",
            measurementId: "G-RY466RXT3D"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId;
        let dbRef;
        let unsubscribe; // To detach the onSnapshot listener later

        // Initialdaten, die nicht dynamisch generiert werden
        const initialTasksData = {
            "general-essentials": [
                { text: "Ausweise, Reisep√§sse", checked: false },
                { text: "Geldb√∂rsen mit Behindertenausweise, Krankenversicherungskarten, F√ºhrerschein", checked: false },
                { text: "Bargeld", checked: false },
                { text: "Parkgroschen", checked: false },
                { text: "Reisedokumente (Buchungsbest√§tigung f√ºr die Ferienwohnung, Reservierungen etc.)", checked: false },
                { text: "Handys", checked: false },
                { text: "2 lange Ladekabel", checked: false },
                { text: "Doppelnetzstecker", checked: false },
                { text: "Hustenbonbons Sina", checked: false },
                { text: "Medikamente Tim", checked: false },
                { text: "Medikamente Juen", checked: false },
                { text: "Fieberz√§pfchen", checked: false },
                { text: "VitaminD", checked: false },
                { text: "Fieberthermometer", checked: false },
                { text: "Nasentropfen", checked: false },
                { text: "Hustensaft", checked: false },
                { text: "Cortisoncreme", checked: false },
                { text: "Pilzspray", checked: false },
                { text: "Mirfulancreme", checked: false },
                { text: "Erk√§ltungsbalsam", checked: false },
                { text: "Ekzem-Creme", checked: false },
                { text: "Krupp Z√§pfchen", checked: false },
                { text: "Medikamente Sina", checked: false },
                { text: "Erste-Hilfe-Set", checked: false },
                { text: "Schmerzen, Fieber, Magen-Darm, √úbelkeit", checked: false },
                { text: "Fieberthermometer", checked: false },
                { text: "Desinfektionsmittel", checked: false },
                { text: "Insektenspray", checked: false },
                { text: "Sonnenbrillen", checked: false },
                { text: "Sonnencreme f√ºr Erwachsene", checked: false },
                { text: "Sonnencreme f√ºr Babys", checked: false },
                { text: "Notfallkontakte", checked: false },
                { text: "Autopapiere und Parkscheine", checked: false },
                { text: "Ohrst√∂psel", checked: false },
                { text: "EU-Reisepass Timmy", checked: false },
                { text: "Tickets", checked: false },
                { text: "Essen f√ºr die Fahrt (mit Nudelsalat, K√§sekuchen)", checked: false },
                { text: "Trinken f√ºr die Fahrt", checked: false },
                { text: "Hartschaumkissen", checked: false },
                { text: "2 FFP2 Masken", checked: false },
                { text: "Zeckenzange", checked: false },
                { text: "Schlemmerblock", checked: false },
                { text: "Regencapes", checked: false },
                { text: "Regenschirme", checked: false },
                { text: "Beutel f√ºr Drecksw√§sche", checked: false }
            ],
            "fuer-das-baby": [
                { text: "Thermoskanne f√ºr Juen Wasser unterwegs (warm!)", checked: false },
                { text: "Wasserkleidung UV", checked: false },
                { text: "Zahnb√ºrste, Zahnpasta", checked: false },
                { text: "1 Flasche f√ºr Juen f√ºr Wasser unterwegs (kalt!)", checked: false },
                { text: "1 Thermoskanne f√ºr Wasser vor Ort abkochen", checked: false },
                { text: "L√∂ffel f√ºr Brei", checked: false },
                { text: "L√∂ffel f√ºr Pre Milch", checked: false },
                { text: "St√§nder f√ºr Fl√§schchen", checked: false },
                { text: "40 Windeln f√ºr 10 Tage", checked: false },
                { text: "11 Pampers Windeln f√ºr nachts", checked: false },
                { text: "1 Paket Feuchtt√ºcher", checked: false },
                { text: "Snuza", checked: false },
                { text: "Otti", checked: false },
                { text: "Kleidung", checked: false },
                { text: "2 M√ºtzen", checked: false },
                { text: "1 Sonnencap", checked: false },
                { text: "3 Pullis", checked: false },
                { text: "3 Strumpfhosen", checked: false },
                { text: "3 kurze Hosen", checked: false },
                { text: "3 lange Hosen", checked: false },
                { text: "3 Halst√ºcher", checked: false },
                { text: "3 kurze Bodys", checked: false },
                { text: "7 lange Bodys", checked: false },
                { text: "4 Paar Socken", checked: false },
                { text: "1 Ganzk√∂rperanzug Kinderwagen", checked: false },
                { text: "Schneeanzug", checked: false },
                { text: "2 Strampler", checked: false },
                { text: "2 Jacken", checked: false },
                { text: "1 Paar Handschuhe", checked: false },
                { text: "2 Paar Schuhe", checked: false },
                { text: "Baby√∂l nach dem Baden", checked: false },
                { text: "Babybrei", checked: false },
                { text: "Babyflaschen", checked: false },
                { text: "Milchpulver", checked: false },
                { text: "Packungen Pre Milch", checked: false },
                { text: "Portionierer", checked: false },
                { text: "Dose f√ºr Milch-Pulver", checked: false },
                { text: "Babydecke", checked: false },
                { text: "2 Schlafs√§cke", checked: false },
                { text: "(Leucht-) Schnuller und Schnullerkette", checked: false },
                { text: "2 Molton-Wickelunterlagen f√ºr drinnen", checked: false },
                { text: "4 kleine Molton-Unterlagen", checked: false },
                { text: "Wickelunterlagen f√ºr unterwegs", checked: false },
                { text: "6 Spuckt√ºcher", checked: false },
                { text: "Wickeltasche", checked: false },
                { text: "2 L√§tzchen", checked: false },
                { text: "Babybadewanne", checked: false },
                { text: "Badethermometer", checked: false },
                { text: "Spielzeug", checked: false },
                { text: "B√ºcher f√ºr das Baby", checked: false },
                { text: "Schnuffel", checked: false },
                { text: "T√∂pfchen", checked: false },
                { text: "Extra Handtuch", checked: false },
                { text: "Badesachen", checked: false },
                { text: "2 Badehosen", checked: false },
                { text: "2 Handt√ºcher", checked: false },
                { text: "Kinderwagen mit", checked: false },
                { text: "Adapter", checked: false },
                { text: "Regenhaube", checked: false },
                { text: "Regencape f√ºr Erwachsene", checked: false },
                { text: "Sonnensegel", checked: false },
                { text: "Insektenschutz", checked: false },
                { text: "Tasche f√ºr Kinderwagen", checked: false },
                { text: "Fu√üsack", checked: false },
                { text: "Schloss f√ºr Kinderwagen", checked: false },
                { text: "Babywippe", checked: false },
                { text: "Hochstuhl", checked: false },
                { text: "1 Spieledecke", checked: false },
                { text: "Stillkissen", checked: false },
                { text: "Nasensauger", checked: false },
                { text: "Reisebett", checked: false },
                { text: "Matratze f√ºr Reisebett", checked: false },
                { text: "Bettw√§sche Baby", checked: false },
                { text: "Baby-Hochstuhl", checked: false },
                { text: "Thermometer f√ºr Wohnung", checked: false },
                { text: "Sterilisator", checked: false },
                { text: "Trage", checked: false },
                { text: "Tragejacke", checked: false },
                { text: "Sonnencreme", checked: false },
                { text: "Waschlappen", checked: false },
                { text: "Bollerwagen", checked: false }
            ],
            "fuer-den-hund": [
                { text: "Hundeleine", checked: false },
                { text: "Geschirr und Halsband mit Hundemarke", checked: false },
                { text: "Futter- und Wassernapf", checked: false },
                { text: "Gen√ºgend Futter f√ºr die Dauer des Aufenthalts", checked: false },
                { text: "Leckerlis und Spielzeug f√ºr den Hund", checked: false },
                { text: "Hundedecke oder K√∂rbchen", checked: false },
                { text: "Kotbeutel und Reinigungsmittel f√ºr eventuelle Unf√§lle", checked: false },
                { text: "Hundemedikamente (falls ben√∂tigt)", checked: false },
                { text: "Informationen zu Tier√§rzten in der N√§he des Urlaubsortes", checked: false },
                { text: "Erdanker mit Laufleine", checked: false }
            ],
            "fuer-die-ferienwohnung": [
                { text: "Bettw√§sche und", checked: false },
                { text: "Handt√ºcher (pr√ºfe vorher, ob diese gestellt werden)", checked: false },
                { text: "Matratzen Bus", checked: false },
                { text: "Geschirr, Besteck und Kochutensilien", checked: false },
                { text: "Lebensmittel (Grundnahrungsmittel und Lieblingssnacks)", checked: false },
                { text: "K√ºchenrolle", checked: false },
                { text: "Sp√ºlmittel", checked: false },
                { text: "M√ºllbeutel", checked: false },
                { text: "Toiletttenpapier", checked: false },
                { text: "Feuchtes Toilettenpapier", checked: false },
                { text: "Seife", checked: false },
                { text: "Picknickdecke", checked: false },
                { text: "Decken oder Kissen f√ºr gem√ºtliche Abende auf dem Sofa", checked: false },
                { text: "Kulturbeutel", checked: false },
                { text: "Zahnb√ºrste", checked: false },
                { text: "Ladekabel", checked: false },
                { text: "Zahnpasta", checked: false },
                { text: "Cremes, Nivea", checked: false },
                { text: "Rasierer", checked: false },
                { text: "Tampons / Einlagen", checked: false },
                { text: "Deo", checked: false },
                { text: "Zahnseide", checked: false },
                { text: "Nagelknipser CC", checked: false },
                { text: "Handcreme", checked: false },
                { text: "Verh√ºtung", checked: false },
                { text: "Sachen f√ºr Kinderwunsch (Ovulationstest, Schwangerschaftstest etc)", checked: false },
                { text: "Waschmittel f√ºr Sp√ºler", checked: false },
                { text: "Waschmittel f√ºr Waschmaschine", checked: false },
                { text: "Rei in der Tube", checked: false },
                { text: "Shampoo und Duschgel", checked: false },
                { text: "Taschenlampe", checked: false },
                { text: "F√∂n", checked: false },
                { text: "Kleine W√§schespinne", checked: false },
                { text: "Sch√§ler", checked: false },
                { text: "Messer", checked: false },
                { text: "Wasserkocher", checked: false },
                { text: "Trinkflasche Tim und Sina", checked: false },
                { text: "Trinkflasche Timmy", checked: false },
                { text: "Thermomix mit ganzem Zubeh√∂r", checked: false },
                { text: "French Press mit L√∂ffel", checked: false },
                { text: "Reste aus dem K√ºhlschrank", checked: false },
                { text: "1-2 Geschirrhandt√ºcher (auch im Hotel) f√ºr L√∂ffelchen, L√§tzchen etc. trocknen", checked: false },
                { text: "1 Besteck Set f√ºr Juen", checked: false },
                { text: "1 Besteck Set f√ºr Erwachsene (f√ºr essen to Go)", checked: false },
                { text: "H-Milch", checked: false },
                { text: "Wasser", checked: false },
                { text: "Wasser im Tank", checked: false },
                { text: "Babygl√§schen mittags und abends", checked: false },
                { text: "L√§tzchen", checked: false },
                { text: "Snacks f√ºr Juen", checked: false },
                { text: "Snacks f√ºr Erwachsene", checked: false },
                { text: "Mundabputzt√ºcher", checked: false },
                { text: "Breipulver Grie√übrei", checked: false },
                { text: "Raps√∂l f√ºr Juen", checked: false },
                { text: "Essen f√ºr die Fahrt oder B√§ckerei anfahren", checked: false },
                { text: "2x Ravioli", checked: false },
                { text: "Kaffeepulver", checked: false },
                { text: "Tee", checked: false },
                { text: "Gew√ºrze", checked: false }
            ],
            "fuer-aktivitaeten-und-unterhaltung": [
                { text: "Wander- oder Radkarten", checked: false },
                { text: "Reisef√ºhrer √ºber Sehensw√ºrdigkeiten und Attraktionen", checked: false },
                { text: "Strandspielzeug f√ºr das Baby", checked: false },
                { text: "B√ºcher, Zeitschriften", checked: false },
                { text: "Smartphone mit Kabel", checked: false },
                { text: "Picknickdecke und -korb f√ºr Ausfl√ºge", checked: false },
                { text: "Spiele oder Spielzeug f√ºr regnerische Tage, Skipbo", checked: false },
                { text: "Taschent√ºcher", checked: false },
                { text: "Strandmuschel", checked: false },
                { text: "Bollerwagen zusammen klappen", checked: false },
                { text: "Kopfh√∂rer", checked: false },
                { text: "Rucksack", checked: false },
                { text: "Regenhaube Rucksack", checked: false },
                { text: "Beutel in den Rucksack f√ºr M√ºtzen /Eink√§ufe etc.", checked: false },
                { text: "Reisef√ºhrer", checked: false },
                { text: "Powerbank", checked: false },
                { text: "Musikbox mit Ladekabel", checked: false },
                { text: "Nackenh√∂rnchen", checked: false },
                { text: "Tablet mit Ladekabel", checked: false },
                { text: "Insektenstich- Brutzler", checked: false },
                { text: "Netzstecker USB", checked: false },
                { text: "Uhr mit Ladekabel", checked: false },
                { text: "Badesachen f√ºr die Eltern", checked: false },
                { text: "Badebekleidung", checked: false },
                { text: "Badelatschen", checked: false },
                { text: "Schwimmbrille", checked: false },
                { text: "Handt√ºcher", checked: false },
                { text: "Saunatucher", checked: false },
                { text: "Strandhandt√ºcher", checked: false }
            ],
            "ggf-fuer-camping": [
                { text: "Fzg Papiere, gr√ºne Versicherungskarte", checked: false },
                { text: "1 Fahrrad mit Decke f√ºr Fahrt oder Fahrradtr√§ger und Fahrradkorb mit Kabelbindern", checked: false },
                { text: "Picknickdecke, die unten nass werden darf", checked: false },
                { text: "Kochplatte Induktion, dann auch geeignete T√∂pfe (die im Camper gehen nicht!)", checked: false },
                { text: "Wasserkocher", checked: false },
                { text: "F√∂n", checked: false },
                { text: "Kaffee?", checked: false },
                { text: "Heizl√ºfter, Heizung", checked: false },
                { text: "Verl√§ngerungskabel", checked: false },
                { text: "2 Schlafs√§cke f√ºr Erwachsene", checked: false },
                { text: "Stillkissen", checked: false },
                { text: "Box f√ºr Schuhe", checked: false },
                { text: "Toaster", checked: false }
            ],
            "sonderaufgaben-div": [
                { text: "Filme runterladen", checked: false },
                { text: "2 Thermoskannen voll mit kochendem Wasser f√ºllen", checked: false },
                { text: "Cybex ohne Station anschnallen √ºben", checked: false },
                { text: "Musik und Podcasts runterladen", checked: false },
                { text: "Rezepte runterladen Thermomix", checked: false },
                { text: "Essen f√ºr die Fahrt", checked: false },
                { text: "Klargrubekabel Speicher", checked: false },
                { text: "M√ºll , Gelbersack leeren", checked: false },
                { text: "Windelm√ºll leeren", checked: false },
                { text: "Rasieren", checked: false },
                { text: "Lebensmittel abgleichen und Rezepte vergleichen", checked: false },
                { text: "Heizung runter", checked: false },
                { text: "Staubsauger sichermachen", checked: false },
                { text: "Stecker raus", checked: false },
                { text: "gie√üen", checked: false },
                { text: "Blumen drinnen", checked: false },
                { text: "Hochbeet", checked: false },
                { text: "Beet", checked: false },
                { text: "Tomaten", checked: false },
                { text: "Erdbeere im H√§ngetopf", checked: false },
                { text: "Blumenstrau√ü r√ºber", checked: false },
                { text: "Lebensmittel r√ºber zu Sinas Eltern?", checked: false },
                { text: "Staubsaugerroboter leeren", checked: false },
                { text: "Kaffee f√ºr die Fahrt", checked: false },
                { text: "Nasensauger putzen", checked: false },
                { text: "W√§sche abh√§ngen", checked: false },
                { text: "Sp√ºl-/ Waschmaschine leeren / anschalten", checked: false },
                { text: "Tomate Haube zumachen", checked: false },
                { text: "Sperrm√ºll an die Stra√üe", checked: false },
                { text: "Sina Rasieren", checked: false },
                { text: "Bus Batterie laden", checked: false },
                { text: "Kaffeemaschine einpacken", checked: false }
            ],
            tripDetails: {
                duration: "7",
                weather: "sonne",
                washingMachine: false,
                startDate: "",
                endDate: ""
            }
        };
        
        const clothingConfig = {
            tim: {
                base: [
                    { text: "T-Shirt", wearFrequency: 1 },
                    { text: "Unterhosen", wearFrequency: 1 },
                    { text: "Socken", wearFrequency: 1 },
                    { text: "Hosen", wearFrequency: 3 },
                    { text: "Pullover", wearFrequency: 2 },
                    { text: "Jacken", wearFrequency: 4 },
                    { text: "Bequeme Schuhe f√ºr Spazierg√§nge und Wandertouren", wearFrequency: Infinity },
                    { text: "Badekleidung mit", wearFrequency: 7 },
                    { text: "Badelatschen", wearFrequency: Infinity },
                    { text: "Sonnenh√ºte oder Kappen", wearFrequency: Infinity },
                    { text: "Schlafkleidung", wearFrequency: 3 },
                    { text: "Schuhanzieher", wearFrequency: Infinity },
                    { text: "Hausschuhe /- Socken", wearFrequency: Infinity },
                    { text: "G√ºrtel", wearFrequency: Infinity },
                    { text: "Orthesen", wearFrequency: Infinity },
                    { text: "Haarmittel", wearFrequency: Infinity },
                    { text: "Schuhe", wearFrequency: Infinity },
                    { text: "Clogs", wearFrequency: Infinity }
                ],
                weather: {
                    regen: [
                        { text: "Regenjacke", quantity: 1 },
                        { text: "Regenschirme", quantity: 1 }
                    ],
                    schnee: [
                        { text: "M√ºtze, Schal", quantity: 1 },
                        { text: "Handschuhe", quantity: 1 },
                        { text: "Thermounterw√§sche", quantity: 2 }
                    ]
                }
            },
            sina: {
                base: [
                    { text: "T-Shirt", wearFrequency: 1 },
                    { text: "Unterhosen", wearFrequency: 1 },
                    { text: "Socken", wearFrequency: 1 },
                    { text: "BH", wearFrequency: 2 },
                    { text: "Hosen", wearFrequency: 3 },
                    { text: "Pullover", wearFrequency: 2 },
                    { text: "Bequeme Schuhe f√ºr Spazierg√§nge und Wandertouren", wearFrequency: Infinity },
                    { text: "Badekleidung", wearFrequency: 7 },
                    { text: "mit Badelatschen", wearFrequency: Infinity },
                    { text: "Outdoorhose mit G√ºrtel", wearFrequency: Infinity },
                    { text: "Sonnenh√ºte oder Kappen", wearFrequency: Infinity },
                    { text: "Schlafkleidung", wearFrequency: 3 },
                    { text: "Hausschuhe /- Socken", wearFrequency: Infinity },
                    { text: "G√ºrtel", wearFrequency: Infinity },
                    { text: "Schuhe", wearFrequency: Infinity },
                    { text: "Wassersandalen", wearFrequency: Infinity },
                    { text: "1 Kleid", wearFrequency: 3 },
                    { text: "Tampons", checked: false },
                    { text: "Clogs", wearFrequency: Infinity }
                ],
                weather: {
                    regen: [
                        { text: "Jacke", quantity: 1 },
                        { text: "Regenjacken, Regencapes und Regenschirme", quantity: 1 }
                    ],
                    schnee: [
                        { text: "M√ºtze, Schal, Handschuhe", quantity: 1 },
                        { text: "Thermounterw√§sche", quantity: 2 }
                    ]
                }
            }
        };

        let tasksData = {};
        let tripDetailsData = {};

        function generateClothingTasks(person, duration, weather, hasWashingMachine) {
            let list = [];
            const baseList = clothingConfig[person].base;
            const weatherList = clothingConfig[person].weather[weather] || [];

            baseList.forEach(item => {
                if (item.wearFrequency !== Infinity) {
                    let quantity = Math.ceil(duration / item.wearFrequency);
                    if (hasWashingMachine && item.wearFrequency <= 2) { 
                        quantity = Math.max(2, Math.ceil(duration / item.wearFrequency / 2));
                    }
                    if (hasWashingMachine && item.wearFrequency > 2) {
                         quantity = Math.max(1, Math.ceil(duration / item.wearFrequency / 1.5));
                    }
                    list.push({ text: `${quantity}x ${item.text}`, checked: false });
                } else {
                    list.push({ text: item.text, checked: false });
                }
            });

            weatherList.forEach(item => {
                list.push({ text: `${item.quantity}x ${item.text}`, checked: false });
            });
            
            return list;
        }

        async function saveData() {
            if (!dbRef) return;
            const dataToSave = { ...tasksData, tripDetails: tripDetailsData };
            try {
                await setDoc(dbRef, dataToSave);
                console.log("Data saved to Firestore.");
            } catch (error) {
                console.error("Error saving data to Firestore: ", error);
            }
        }

        function loadData() {
            if (!dbRef) return;

            if (unsubscribe) {
                unsubscribe();
            }
            
            unsubscribe = onSnapshot(dbRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    tripDetailsData = data.tripDetails || initialTasksData.tripDetails;
                    const { tripDetails, ...restOfTasks } = data;
                    tasksData = restOfTasks;
                    console.log("Data loaded from Firestore.");
                } else {
                    console.log("No data found in Firestore, using initial data.");
                    const { tripDetails, ...restOfTasks } = initialTasksData;
                    tasksData = restOfTasks;
                    tripDetailsData = tripDetails;
                    saveData();
                }
                updateTripDetailsUI();
                renderTasks();
            }, (error) => {
                console.error("Error listening to document:", error);
            });
        }

        function updateTripDetailsUI() {
            document.getElementById("trip-duration").value = tripDetailsData.duration;
            document.getElementById("weather-select").value = tripDetailsData.weather;
            document.getElementById("washing-machine").checked = tripDetailsData.washingMachine;
            document.getElementById("trip-start-date").value = tripDetailsData.startDate;
            document.getElementById("trip-end-date").value = tripDetailsData.endDate;
        }

        function renderTasks() {
            document.querySelectorAll('.task-list, .special-tasks-list').forEach(ul => ul.innerHTML = '');

            const duration = parseInt(tripDetailsData.duration) || 0;
            const weather = tripDetailsData.weather;
            const hasWashingMachine = tripDetailsData.washingMachine;

            const getCustomTasks = (category) => {
                if (!tasksData[category]) return [];
                return tasksData[category].filter(task => !/^\d+x /.test(task.text));
            };

            const customTasksTim = getCustomTasks('kleidung-tim');
            const customTasksSina = getCustomTasks('kleidung-sina');

            tasksData['kleidung-tim'] = generateClothingTasks('tim', duration, weather, hasWashingMachine).concat(customTasksTim);
            tasksData['kleidung-sina'] = generateClothingTasks('sina', duration, weather, hasWashingMachine).concat(customTasksSina);
            
            document.querySelector('#kleidung-tim h2').textContent = `üëï Kleidung TME f√ºr ${duration} Tage`;
            document.querySelector('#kleidung-sina h2').textContent = `üëó Kleidung SINA f√ºr ${duration} Tage`;

            for (const category in tasksData) {
                if (category === 'tripDetails') continue;
                const ul = document.querySelector(`#${category} .task-list, #${category} .special-tasks-list`);
                if (ul) {
                    tasksData[category].forEach((task, index) => {
                        const li = document.createElement("li");
                        li.dataset.index = index;
                        li.dataset.category = category;
                        li.setAttribute('draggable', 'true');
                        
                        const taskTextClass = 'task-text';
                        
                        li.innerHTML = `
                            <input type="checkbox" id="checkbox-${category}-${index}" ${task.checked ? 'checked' : ''}>
                            <span class="${taskTextClass}">${task.text}</span>
                            <div class="task-buttons">
                                <button class="edit-btn" title="Bearbeiten">üìù</button>
                                <button class="delete-btn" title="L√∂schen">‚ùå</button>
                            </div>
                        `;
                        ul.appendChild(li);
                    });
                }
            }
            addEventListeners();
            checkVacationWarning(); 
        }
        
        function addEventListeners() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const li = e.target.closest('li');
                    if (!li) return;
                    const category = li.dataset.category;
                    const index = parseInt(li.dataset.index);
                    if (tasksData[category] && tasksData[category][index]) {
                        tasksData[category][index].checked = e.target.checked;
                        saveData();
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const li = e.target.closest('li');
                     if (!li) return;
                    const category = li.dataset.category;
                    const index = parseInt(li.dataset.index);
                     if (tasksData[category] && tasksData[category][index]) {
                        tasksData[category].splice(index, 1);
                        saveData();
                    }
                });
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const li = e.target.closest('li');
                    if (!li) return;
                    const category = li.dataset.category;
                    const taskTextSpan = li.querySelector('.task-text');
                    const currentText = taskTextSpan.textContent;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentText;
                    input.classList.add('task-text');
                    taskTextSpan.replaceWith(input);
                    input.focus();

                    const saveEdit = () => {
                        const newText = input.value;
                        const span = document.createElement('span');
                        span.classList.add('task-text');
                        span.textContent = newText;
                        input.replaceWith(span);
                        const index = parseInt(li.dataset.index);
                        if (tasksData[category] && tasksData[category][index]) {
                            tasksData[category][index].text = newText;
                            saveData();
                        }
                    };
                    input.addEventListener('blur', saveEdit);
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            saveEdit();
                        }
                    });
                });
            });

            document.querySelectorAll('.add-task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryElement = e.target.closest('.category');
                    if (categoryElement) {
                        const category = categoryElement.id;
                        const input = categoryElement.querySelector('.add-task-container input');
                        const newTaskText = input.value.trim();
                        if (newTaskText) {
                            if (!tasksData[category]) tasksData[category] = [];
                            tasksData[category].push({ text: newTaskText, checked: false });
                            input.value = '';
                            saveData();
                        }
                    }
                });
            });
            
            document.getElementById('add-special-task-btn').addEventListener('click', () => {
                const input = document.getElementById('new-special-task-input');
                const newTaskText = input.value.trim();
                if (newTaskText) {
                    if (!tasksData['sonderaufgaben-div']) tasksData['sonderaufgaben-div'] = [];
                    tasksData['sonderaufgaben-div'].push({ text: newTaskText, checked: false });
                    input.value = '';
                    saveData();
                }
            });

            let dragItem = null;
            document.querySelectorAll('.task-list, .special-tasks-list').forEach(ul => {
                ul.addEventListener('dragstart', (e) => {
                    dragItem = e.target;
                    setTimeout(() => dragItem.classList.add('dragging'), 0);
                });
                ul.addEventListener('dragend', () => {
                    if (!dragItem) return;
                    dragItem.classList.remove('dragging');
                    const li = dragItem;
                    dragItem = null;
                    
                    const category = ul.closest('.category, .special-tasks').id;
                    const newOrder = [];
                    ul.querySelectorAll('li').forEach(item => {
                        const itemCategory = item.dataset.category;
                        const itemIndex = parseInt(item.dataset.index);
                        if(tasksData[itemCategory] && tasksData[itemCategory][itemIndex]) {
                            newOrder.push(tasksData[itemCategory][itemIndex]);
                        }
                    });

                    if (tasksData[category]) {
                        tasksData[category] = newOrder;
                        saveData();
                    }
                });

                ul.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(ul, e.clientY);
                    const draggable = document.querySelector('.dragging');
                    if (draggable) {
                        if (afterElement == null) {
                            ul.appendChild(draggable);
                        } else {
                            ul.insertBefore(draggable, afterElement);
                        }
                    }
                });
            });
            
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('li:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: -Infinity }).element;
            }
        }
        
        function checkVacationWarning() {
            const vacationWarningDiv = document.getElementById('vacation-warning');
            const tripStartDate = tripDetailsData.startDate;
            const tripEndDate = tripDetailsData.endDate;

            if (!tripStartDate || !tripEndDate || !tasksData['sonderaufgaben-div']) {
                vacationWarningDiv.classList.remove('visible');
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const start = new Date(tripStartDate);
            start.setHours(0, 0, 0, 0);
            const end = new Date(tripEndDate);
            end.setHours(23, 59, 59, 999); 

            if (today >= start && today <= end) {
                const uncheckedSpecialTasks = tasksData['sonderaufgaben-div'].filter(task => !task.checked);
                if (uncheckedSpecialTasks.length > 0) {
                    const taskList = uncheckedSpecialTasks.map(task => `"${task.text}"`).join(', ');
                    vacationWarningDiv.innerHTML = `
                        <strong>Hallo TME!</strong> Denk dran, w√§hrend deines Urlaubs stehen noch folgende Sonderaufgaben an:
                        <br>
                        ${taskList}. Viel Erfolg beim Erledigen und genie√üe die Zeit!
                    `;
                    vacationWarningDiv.classList.add('visible');
                } else {
                    vacationWarningDiv.classList.remove('visible');
                }
            } else {
                vacationWarningDiv.classList.remove('visible');
            }
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                console.log("User signed in with UID:", userId);
                // Use a consistent document ID for a single user's checklist
                dbRef = doc(db, "checklists", "userChecklist");
                loadData(); // Load data once we have the user ID
            } else {
                 // User is signed out.
                console.log("User is signed out. Signing in anonymously...");
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                });
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            const dateToday = new Date();
            document.getElementById("date").textContent = dateToday.toLocaleDateString("de-DE", {
                weekday: "long", year: "numeric", month: "long", day: "numeric"
            });

            document.getElementById('search-input').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.category, .special-tasks').forEach(categoryDiv => {
                    const tasks = categoryDiv.querySelectorAll('li');
                    let hasVisibleTasks = false;
                    tasks.forEach(taskLi => {
                        const taskText = taskLi.querySelector('.task-text').textContent.toLowerCase();
                        if (taskText.includes(searchTerm)) {
                            taskLi.style.display = '';
                            hasVisibleTasks = true;
                        } else {
                            taskLi.style.display = 'none';
                        }
                    });
                    if (!hasVisibleTasks && searchTerm !== '') {
                        categoryDiv.style.display = 'none';
                    } else {
                        categoryDiv.style.display = '';
                    }
                });
            });

            document.getElementById("updateBtn").addEventListener("click", function() {
                tripDetailsData.duration = document.getElementById("trip-duration").value;
                tripDetailsData.weather = document.getElementById("weather-select").value;
                tripDetailsData.washingMachine = document.getElementById("washing-machine").checked;
                tripDetailsData.startDate = document.getElementById("trip-start-date").value;
                tripDetailsData.endDate = document.getElementById("trip-end-date").value;
                saveData();
            });

            document.getElementById("printBtn").addEventListener("click", function() {
                window.print();
            });

            document.getElementById("resetBtn").addEventListener("click", async function () {
                if (confirm("M√∂chtest du wirklich alle eigenen Eintr√§ge und Haken zur√ºcksetzen?")) {
                    if (dbRef) {
                        try {
                            await deleteDoc(dbRef);
                            console.log("Document successfully deleted!");
                        } catch (error) {
                            console.error("Error removing document: ", error);
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
